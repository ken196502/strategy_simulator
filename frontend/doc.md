# 模拟交易撮合流程

#### 订单撮合引擎
**order_executor.py** 负责处理用户买入和卖出股票的完整流程：

**执行流程：**
1. **验证要求** - 检查订单是否符合交易规则：
   - 股票数量必须符合市场最小交易量要求
   - 股票数量必须是交易单位（手数）的整数倍
   - 检查用户是否有足够资金（买入）或持仓（卖出）

2. **价格确定** - 根据订单类型确定成交价格：
   - 限价订单：使用用户设定的价格
   - 市价订单：使用当前最新市场价格

3. **扣费和结算** - 计算实际交易金额：
   - 交易本金 = 成交价 × 股票数量
   - 手续费 = 本金 × 手续费率（不低于最低手续费）
   - 买入：现金 - (本金 + 手续费)
   - 卖出：现金 + (本金 - 手续费)

4. **持仓更新** - 更新用户的持股情况：
   - 买入：计算平均成本，增加持仓数量
   - 卖出：减少持仓数量，价格更新为最新成交价

**字段更新：**
- **现金流水** - 各币种现金余额实时更新（USD/HKD/CNY）
- **持仓记录** - 持股数量、可卖数量、平均成本同步更新
- **交易历史** - 生成成交记录，包含成交价格、数量、手续费
- **订单状态** - 订单状态从"等待"变为"成交"

#### 资产记录服务
**asset_snapshot_service.py** 负责记录和管理用户的资产变动历史：

**记录流程：**
1. **数据收集** - 梳理用户的全部交易记录
2. **时间序列处理** - 按时间顺序逐步计算每日资产状况
3. **估值计算** - 使用当日收盘价计算持仓市值
4. **汇率转换** - 将各币种资产统一转换为美元基准
5. **历史存储** - 生成每日资产快照，记录当日总资产、现金、持仓

**资产构成分析：**
- **总资产** = 现金 + 持仓市值（已转换为美元）
- **资金明细** - 分别记录各币种现金余额
- **持仓明细** - 各币种持仓价值的分布
- **收益统计** - 计算当日盈亏和累计盈亏

**字段更新：**
- **每日快照** - 记录每个交易日的资产状况
- **趋势分析** - 生成资产变化的时间序列数据
- **汇率管理** - 维持USD/HKD/CNY之间的汇率关系