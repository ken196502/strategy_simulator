# 智能行情刷新策略

## 概述

为了减少对雪球API的请求频率，避免被封号，系统实现了基于市场交易时间的智能刷新策略。

## 核心逻辑

### 1. 市场交易时间判断 (`marketHours.ts`)

**美股（US）**
- 交易时间：21:30 - 05:00（北京时间）
- 说明：包含夏令时和冬令时，简化为固定时间段

**港股（HK）**
- 交易时间：09:30 - 16:00（北京时间）
- 午休时间：12:00 - 13:00（暂未实现）

**A股（CN）**
- 交易时间：09:30 - 15:00（北京时间）
- 午休时间：11:30 - 13:00（暂未实现）

**周末**
- 所有市场周六、周日不交易

### 2. 智能刷新策略 (`marketData.ts`)

#### 刷新频率

| 场景 | 刷新间隔 | 说明 |
|------|----------|------|
| **有持仓/待成交订单 + 任一市场开盘** | 3秒 | 高频刷新，保证行情实时性 |
| **有持仓 + 全部市场休市** | 60秒 | 低频刷新，减少请求 |
| **无持仓** | 不刷新 | 完全停止请求 |

#### 防抖机制

- 最小刷新间隔：3秒
- 防止短时间内重复请求

#### 按市场分类

系统会自动识别持仓和待成交订单的市场类型：
- `.HK` 结尾 → 港股
- `.CN` 结尾 → A股
- 其他 → 美股

只有对应市场开盘时才会发送请求，并在日志中显示：

```
📡 刷新行情 [开盘: US(2), HK(3)]
```

### 3. 持仓追踪

系统自动追踪需要更新行情的股票：
- **持仓股票**：所有当前持有的股票
- **待成交订单**：状态为 `pending` 的订单股票

当持仓或订单变化时，自动更新需要刷新的股票列表。

## 使用示例

### 场景1：港股交易时间

```
时间：10:30（北京时间）
持仓：00700.HK, 00127.HK
状态：港股开盘
结果：每3秒刷新一次
日志：📡 刷新行情 [开盘: HK(2)]
```

### 场景2：全部休市

```
时间：18:00（北京时间）
持仓：00700.HK, AAPL.US
状态：所有市场休市
结果：每60秒刷新一次
日志：无（静默刷新）
```

### 场景3：无持仓

```
持仓：无
订单：无
结果：不发送请求
```

### 场景4：美股+港股混合持仓

```
时间：22:00（北京时间）
持仓：AAPL.US, 00700.HK
状态：美股开盘，港股休市
结果：每3秒刷新一次（因为美股开盘）
日志：📡 刷新行情 [开盘: US(1)]
```

## 优势

1. **减少API请求**
   - 休市时间降低频率（60秒 vs 3秒）
   - 无持仓时完全停止请求
   - 只在必要时发送请求

2. **避免封号风险**
   - 遵守合理的请求频率
   - 根据实际需要动态调整

3. **保证交易体验**
   - 开盘时保持高频刷新（3秒）
   - 订单能及时撮合成交

4. **智能化**
   - 自动识别市场类型
   - 自动追踪持仓变化
   - 日志清晰可追溯

## 注意事项

1. **时区简化**
   - 当前使用本地时间判断
   - 实际部署应该转换到对应市场时区

2. **午休时间**
   - 港股和A股的午休时间暂未实现
   - 可以进一步优化以减少请求

3. **节假日**
   - 未考虑市场节假日
   - 可以接入日历API进一步优化

## 未来优化

- [ ] 实现午休时间判断
- [ ] 接入市场日历API
- [ ] 精确的时区转换
- [ ] 根据服务器响应时间动态调整频率
- [ ] 支持批量股票查询（减少请求次数）
